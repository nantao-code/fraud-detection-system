# 回归任务使用指南

## 概述

本项目已升级为支持**分类和回归双任务**的机器学习框架。除原有的欺诈检测（分类）功能外，现新增**欺诈损失金额预测**（回归）功能。

## 支持的回归模型

| 模型类型 | 说明 | 适用场景 |
|---------|------|----------|
| **RIDGE** | Ridge回归（L2正则化线性回归） | 特征维度高、需要正则化 |
| **XGB_REG** | XGBoost回归器 | 复杂非线性关系、特征交互 |
| **RF_REG** | 随机森林回归器 | 鲁棒性强、可处理缺失值 |
| **LGB_REG** | LightGBM回归器 | 大数据集、快速训练 |

## 快速开始

### 1. 准备回归数据

回归任务的数据格式与分类任务相同，但目标变量应为**连续数值**（如欺诈损失金额）。

```csv
# 示例数据格式
feature1,feature2,feature3,category1,fraud_amount
0.5,1.2,3.4,A,1500.50
2.1,0.8,1.9,B,850.75
...（其他特征和数值）...
```

### 2. 使用回归配置

使用专门的回归配置文件：

```python
from src.unified_config import UnifiedConfig
from src.pipeline_training import PipelineTraining

# 加载回归配置
config = UnifiedConfig('config_regression.yaml')

# 创建训练器
trainer = PipelineTraining(config)

# 运行回归模型训练
results = trainer.run_all_models()
```

### 3. 自定义回归训练

#### 单个模型训练

```python
from src.unified_config import UnifiedConfig
from src.model_training import ModelTraining

# 初始化配置
config = UnifiedConfig('config_regression.yaml')

# 创建训练器
training = ModelTraining(config)

# 训练单个回归模型
result = training.train_model('XGB_REG')
print(f"XGBoost回归结果: R² = {result['r2']}")
```

#### 批量训练特定模型

```python
# 只训练部分回归模型
config.set('modeling.regression_models', ['XGB_REG', 'RF_REG'])
training = ModelTraining(config)
training.batch_train()
```

## 配置文件详解

### 回归配置示例 (`config_regression.yaml`)

```yaml
# 特征工程配置
feature_engineering:
  target_column: fraud_amount  # 回归目标变量
  
  # 回归评估指标
  primary_metric_regression: neg_root_mean_squared_error
  scoring_metrics_regression:
    - neg_root_mean_squared_error
    - neg_mean_absolute_error
    - r2

# 模型配置
modeling:
  # 禁用分类模型
  models: []
  
  # 启用回归模型
  regression_models:
    - RIDGE
    - XGB_REG
    - RF_REG
    - LGB_REG
  
  # 回归模型参数
  ridge_regression:
    alpha: [0.1, 1.0, 10.0]
    
  xgboost_regression:
    n_estimators: [500, 1000]
    learning_rate: [0.01, 0.1]
    max_depth: [3, 6, 9]
    
  random_forest_regression:
    n_estimators: [100, 200]
    max_depth: [None, 10, 20]
    
  lightgbm_regression:
    n_estimators: [500, 1000]
    learning_rate: [0.01, 0.1]
    max_depth: [-1, 5, 10]

# 性能监控阈值
monitoring:
  performance_thresholds:
    regression:
      mse: 0.1
      rmse: 0.3
      mae: 0.25
      r2: 0.7
```

## 回归评估指标

系统支持以下回归评估指标：

| 指标 | 全称 | 说明 | 理想值 |
|-----|------|------|--------|
| **MSE** | Mean Squared Error | 均方误差 | 越小越好 |
| **RMSE** | Root Mean Squared Error | 均方根误差 | 越小越好 |
| **MAE** | Mean Absolute Error | 平均绝对误差 | 越小越好 |
| **R²** | R-squared | 决定系数 | 越接近1越好 |
| **MAPE** | Mean Absolute Percentage Error | 平均绝对百分比误差 | 越小越好 |

## 实际应用示例

### 欺诈损失金额预测

```python
import pandas as pd
from src.unified_config import UnifiedConfig
from src.pipeline_training import PipelineTraining

# 1. 准备数据
data = pd.read_csv('data/fraud_transactions.csv')
print(f"数据形状: {data.shape}")
print(f"目标变量统计: {data['loss_amount'].describe()}")

# 2. 配置训练
config = UnifiedConfig('config_regression.yaml')
trainer = PipelineTraining(config)

# 3. 运行训练
results = trainer.run_all_models()

# 4. 查看结果
for result in results:
    print(f"模型: {result['model_name']}")
    print(f"  R²: {result['r2']:.4f}")
    print(f"  RMSE: {result['rmse']:.4f}")
    print(f"  MAE: {result['mae']:.4f}")
```

### 自定义特征工程

```python
config = UnifiedConfig('config_regression.yaml')

# 启用高级特征工程
config.set('feature_engineering.use_advanced_engineering', True)
config.set('feature_engineering.create_polynomial_features', True)
config.set('feature_engineering.create_interaction_features', True)

# 训练模型
trainer = PipelineTraining(config)
results = trainer.run_all_models()
```

## 注意事项

### 1. 数据要求
- **目标变量**：必须为连续数值，不能是分类标签
- **缺失值**：系统会自动处理缺失值
- **特征类型**：支持数值和分类特征

### 2. 性能优化
- **大数据集**：建议使用 LightGBM 回归器（LGB_REG）
- **小数据集**：Ridge 回归可能更稳定
- **非线性关系**：XGBoost 或随机森林回归器效果更好

### 3. 常见错误排查

| 错误信息 | 原因 | 解决方案 |
|---------|------|----------|
| "不支持的模型类型" | 使用了分类模型 | 使用回归模型：RIDGE, XGB_REG, RF_REG, LGB_REG |
| "目标变量类型错误" | 目标变量不是数值 | 检查目标列是否包含非数值数据 |
| "找不到回归模型" | 配置文件错误 | 检查 `regression_models` 配置项 |

## 最佳实践

### 1. 模型选择
- **线性关系**：优先使用 RIDGE
- **复杂关系**：使用 XGB_REG 或 RF_REG
- **大数据**：使用 LGB_REG

### 2. 参数调优
```python
# 调整超参数搜索范围
config.set('modeling.n_iter', 50)  # 增加搜索迭代次数
config.set('modeling.xgboost_regression.max_depth', [3, 6, 9, 12])
```

### 3. 结果解释
```python
# 获取特征重要性
from src.pipeline_training import PipelineTraining

trainer = PipelineTraining(config)
best_model = trainer.get_best_model()

# 查看特征重要性
importance_df = trainer.get_feature_importance()
print(importance_df.sort_values('importance', ascending=False).head(10))
```

## 扩展开发

如需添加新的回归模型，请：

1. 在 `model_factory.py` 中添加模型创建方法
2. 在配置文件中添加对应参数
3. 更新评估指标计算逻辑
4. 添加模型测试用例

## 技术支持

如遇到技术问题，请：

1. 查看 `logs/` 目录下的日志文件
2. 运行测试脚本：`python test_regression.py`
3. 检查配置文件格式是否正确
4. 确保所有依赖库已正确安装